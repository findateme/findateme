<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="alternate icon" href="favicon.svg" type="image/svg+xml" />
  <title>DateMe â€” Inbox</title>

  <!-- Preload critical resources for faster loading -->
  <link rel="preload" href="style.css" as="style" />
  <link rel="preload" href="shared-theme.css" as="style" />
  <link rel="preload" href="config.js" as="script" />
  
  <link rel="stylesheet" href="browser-compatibility.css" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="shared-theme.css" />

  <script src="browser-polyfills.js"></script>
  <script src="config.js"></script>
  <script src="performance.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Verify user exists BEFORE loading page -->
  <script>
    (async function() {
      const activeEmail = localStorage.getItem("dateme_active_user");
      if (activeEmail) {
        try {
          const API_BASE = window.API_BASE || "https://fin-date-me.onrender.com";
          const res = await fetch(`${API_BASE}/get_users.php?t=${Date.now()}`);
          const data = await res.json();
          const userExists = data.ok && data.users && data.users.some(u => 
            String(u.email || "").toLowerCase() === activeEmail.toLowerCase()
          );
          if (!userExists) {
            localStorage.clear();
            sessionStorage.clear();
            alert("Your account has been deleted.");
            window.location.href = "login.html";
            return;
          }
        } catch (e) { }
      }
    })();
  </script>
  
  <script src="auth.js" defer></script>
  <script src="inbox.js" defer></script>
</head>

<body data-page="inbox">
  <div class="bg-float">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
  </div>
  <!-- ğŸŒŸ Emoji Orbits -->
  <div class="emoji-orbit">
    <!-- Top Left Orbit -->
    <div class="orbit-container" style="top: 10%; left: 5%; animation-duration: 20s;">
      <div class="orbit-emoji" style="top: -12px; left: 50%; transform: translateX(-50%);">â¤ï¸</div>
      <div class="orbit-emoji" style="bottom: -12px; left: 50%; transform: translateX(-50%);">ğŸ’•</div>
      <div class="orbit-emoji" style="left: -12px; top: 50%; transform: translateY(-50%);">âœ¨</div>
      <div class="orbit-emoji" style="right: -12px; top: 50%; transform: translateY(-50%);">ğŸ’–</div>
    </div>
    <!-- Right Side Orbit -->
    <div class="orbit-container alt" style="top: 35%; right: 8%; width: 250px; height: 250px; animation-duration: 25s;">
      <div class="orbit-emoji" style="top: -10px; left: 50%; transform: translateX(-50%);">ğŸ’—</div>
      <div class="orbit-emoji" style="bottom: -10px; left: 50%; transform: translateX(-50%);">â­</div>
      <div class="orbit-emoji" style="left: -10px; top: 50%; transform: translateY(-50%);">ğŸ’</div>
      <div class="orbit-emoji" style="right: -10px; top: 50%; transform: translateY(-50%);">ğŸŒ¹</div>
    </div>
    <!-- Bottom Center Orbit -->
    <div class="orbit-container" style="bottom: 15%; left: 50%; transform: translateX(-50%); width: 280px; height: 280px; animation-duration: 30s;">
      <div class="orbit-emoji" style="top: -14px; left: 50%; transform: translateX(-50%);">ğŸ’‘</div>
      <div class="orbit-emoji" style="bottom: -14px; left: 50%; transform: translateX(-50%);">ğŸ’</div>
      <div class="orbit-emoji" style="left: -14px; top: 50%; transform: translateY(-50%);">ğŸ€</div>
      <div class="orbit-emoji" style="right: -14px; top: 50%; transform: translateY(-50%);">ğŸ’˜</div>
    </div>
  </div>
  <div class="inboxShell">
    <!-- Sidebar (Messenger-style) -->
    <aside class="inboxSidebar">
      <div class="inboxSidebar__top">
        <a class="backToHome" href="home.html" title="Back to Home" style="display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; background:var(--card); border:1px solid var(--stroke); transition:all 0.2s ease; text-decoration:none; margin-bottom:12px;">
          <span style="font-size:20px;">â†</span>
          <span style="font-size:14px; font-weight:600; color:var(--text);">Back</span>
        </a>
        <a class="logo" href="home.html" aria-label="DateMe Home">
          <svg class="logoMark" viewBox="0 0 120 120" role="img" aria-hidden="true">
            <path
              d="M60 104
                 C60 104, 18 76, 18 42
                 C18 22, 34 10, 50 10
                 C67 10, 79 23, 84 33
                 C89 23, 101 10, 118 10
                 C134 10, 150 22, 150 42
                 C150 76, 60 104, 60 104 Z"
              fill="none"
              stroke="rgba(255,255,255,.92)"
              stroke-width="8"
              stroke-linejoin="round"
              stroke-linecap="round"
              transform="translate(-24,0)"
            />
            <path
              d="M60 100
                 C60 100, 24 74, 24 44
                 C24 28, 36 18, 50 18
                 C64 18, 74 27, 80 36
                 C86 27, 96 18, 110 18
                 C124 18, 136 28, 136 44
                 C136 74, 60 100, 60 100 Z"
              fill="none"
              stroke="rgba(255,77,109,.95)"
              stroke-width="4"
              stroke-linejoin="round"
              stroke-linecap="round"
              transform="translate(-8,0)"
              opacity=".95"
            />
          </svg>
          <span class="logoType"><b>Date</b>Me</span>
        </a>
        <div class="inboxSidebar__actions"></div>
      </div>

      <div class="inboxSearch">
        <input class="inboxSearch__input" type="text" placeholder="Search Messenger" aria-label="Search" />
      </div>

      <div class="inboxSectionLabel">Chats</div>
      <div id="threadList" class="contacts"></div>

      <div id="emptyThreads" class="inboxEmpty" style="display:none;">
        No chats yet. Go to People â†’ open a profile â†’ Chat.
      </div>

      <div class="inboxSidebar__foot"></div>
    </aside>

    <!-- Chat panel -->
    <section class="inboxChat">
      <div class="inboxChat__head">
        <div class="inboxChat__user">
          <div class="inboxChat__avatar" id="chatAvatarWrap">
            <span class="inboxChat__avatarIcon" aria-hidden="true">ğŸ‘¤</span>
            <img id="chatAvatar" alt="" loading="lazy" />
          </div>
          <div class="inboxChat__meta">
            <div id="chatTitle" class="inboxChat__title">Select a chat</div>
            <div id="chatSub" class="muted">â€”</div>
          </div>
        </div>
        <div class="callActions">
          <button class="iconbtn callBtn backBtn" id="chatBackBtn" type="button" title="Back">â†</button>
          <button class="iconbtn callBtn" id="audioCallBtn" type="button" title="Audio call">ğŸ“</button>
          <button class="iconbtn callBtn video" id="videoCallBtn" type="button" title="Video call" aria-label="Video call">
            <svg class="callIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M14 7H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M16 10.5 20 8v8l-4-2.5v-3Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="chatProfileCard" id="chatProfileCard" aria-hidden="true"></div>
      </div>

      <div id="chatBody" class="inboxChat__body"></div>

      <div class="inboxChat__composer">
        <div id="msgCounter" style="display:none; padding:8px 12px; background:rgba(255,79,216,.1); border-radius:8px; margin-bottom:8px; font-size:12px; text-align:center;">
          <span id="msgCounterText"></span>
        </div>
        <button class="inboxChat__emojiBtn" id="emojiBtn" type="button">ğŸ˜Š</button>
        <button class="inboxChat__stickerBtn" id="stickerBtn" type="button">ğŸ’—</button>
        <input id="chatInput" class="inboxChat__input" placeholder="Aa" />
        <button id="sendBtn" class="inboxChat__send" type="button">Send</button>
      </div>
      <div class="emojiPicker" id="emojiPicker" style="display:none;">
        <button type="button">ğŸ˜€</button>
        <button type="button">ğŸ˜</button>
        <button type="button">ğŸ¥°</button>
        <button type="button">ğŸ˜Š</button>
        <button type="button">ğŸ˜‰</button>
        <button type="button">ğŸ˜˜</button>
        <button type="button">ğŸ˜‚</button>
        <button type="button">ğŸ˜…</button>
        <button type="button">ğŸ˜‡</button>
        <button type="button">ğŸ˜</button>
        <button type="button">ğŸ¤</button>
        <button type="button">â¤ï¸</button>
        <button type="button">ğŸ”¥</button>
        <button type="button">âœ¨</button>
        <button type="button">ğŸ’¯</button>
        <button type="button">ğŸ™</button>
      </div>
      <div class="stickerPicker" id="stickerPicker" style="display:none;">
        <div class="stickerGrid">
          <div class="sticker">ğŸ’—</div>
          <div class="sticker">ğŸ’•</div>
          <div class="sticker">ğŸ’</div>
          <div class="sticker">â¤ï¸</div>
          <div class="sticker">ğŸ˜</div>
          <div class="sticker">ğŸ˜˜</div>
          <div class="sticker">ğŸ¥°</div>
          <div class="sticker">ğŸ’˜</div>
          <div class="sticker">ğŸ’</div>
          <div class="sticker">ğŸ’–</div>
          <div class="sticker">ğŸ’Ÿ</div>
          <div class="sticker">ğŸ’“</div>
          <div class="sticker">ğŸ’Œ</div>
          <div class="sticker">ğŸ’</div>
          <div class="sticker">ğŸ’</div>
          <div class="sticker">ğŸŒ¹</div>
          <div class="sticker">ğŸŒ·</div>
          <div class="sticker">ğŸ§¸</div>
          <div class="sticker">âœ¨</div>
          <div class="sticker">ğŸŒ™</div>
          <div class="sticker">ğŸ</div>
          <div class="sticker">ğŸ’«</div>
          <div class="sticker">ğŸ«¶</div>
          <div class="sticker">ğŸ¥º</div>
          <div class="sticker">ğŸ˜»</div>
          <div class="sticker">ğŸ’‘</div>
          <div class="sticker">ğŸ‘©â€â¤ï¸â€ğŸ‘¨</div>
          <div class="sticker">ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨</div>
          <div class="sticker">ğŸ’‹</div>
          <div class="sticker">ğŸ’„</div>
          <div class="sticker">ğŸ¦‹</div>
          <div class="sticker">ğŸ«</div>
        </div>
      </div>
    </section>
  </div>

  <div class="callNotice" id="callNotice" aria-hidden="true">
    <div class="callNotice__backdrop" id="callNoticeClose"></div>
    <div class="callNotice__panel" role="dialog" aria-modal="true">
      <h3>Upgrade Required</h3>
      <p>You canâ€™t place calls until you upgrade your account.</p>
      <a class="btn primary" href="profile-upgrade.html">Upgrade Now</a>
    </div>
  </div>

  <div class="callNotice" id="msgLimitNotice" aria-hidden="true">
    <div class="callNotice__backdrop" id="msgLimitClose"></div>
    <div class="callNotice__panel" role="dialog" aria-modal="true">
      <h3>ğŸ’¬ Message Limit Reached</h3>
      <p style="margin-bottom:16px;">You've used all your free messages!</p>
      <div style="background:rgba(255,79,216,.1); padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span>âœ¨ Basic Plan</span>
          <span style="font-weight:700;">500 messages - $14/mo</span>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span>ğŸš€ Premium Plan</span>
          <span style="font-weight:700;">1,000 messages - $30/mo</span>
        </div>
      </div>
      <a class="btn primary" href="profile-upgrade.html" style="width:100%; text-align:center;">Upgrade Now</a>
    </div>
  </div>
  <script src="keep-alive.js"></script>
</body>
</html>
