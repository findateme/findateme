<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DateMe â€” Profile</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body data-page="profile-view">
  <!-- ğŸŒŸ Emoji Orbits -->
  <div class="emoji-orbit">
    <!-- Top Left Orbit -->
    <div class="orbit-container" style="top: 10%; left: 5%; animation-duration: 20s;">
      <div class="orbit-emoji" style="top: -12px; left: 50%; transform: translateX(-50%);">â¤ï¸</div>
      <div class="orbit-emoji" style="bottom: -12px; left: 50%; transform: translateX(-50%);">ğŸ’•</div>
      <div class="orbit-emoji" style="left: -12px; top: 50%; transform: translateY(-50%);">âœ¨</div>
      <div class="orbit-emoji" style="right: -12px; top: 50%; transform: translateY(-50%);">ğŸ’–</div>
    </div>
    <!-- Right Side Orbit -->
    <div class="orbit-container alt" style="top: 35%; right: 8%; width: 250px; height: 250px; animation-duration: 25s;">
      <div class="orbit-emoji" style="top: -10px; left: 50%; transform: translateX(-50%);">ğŸ’—</div>
      <div class="orbit-emoji" style="bottom: -10px; left: 50%; transform: translateX(-50%);">â­</div>
      <div class="orbit-emoji" style="left: -10px; top: 50%; transform: translateY(-50%);">ğŸ’</div>
      <div class="orbit-emoji" style="right: -10px; top: 50%; transform: translateY(-50%);">ğŸŒ¹</div>
    </div>
    <!-- Bottom Center Orbit -->
    <div class="orbit-container" style="bottom: 15%; left: 50%; transform: translateX(-50%); width: 280px; height: 280px; animation-duration: 30s;">
      <div class="orbit-emoji" style="top: -14px; left: 50%; transform: translateX(-50%);">ğŸ’‘</div>
      <div class="orbit-emoji" style="bottom: -14px; left: 50%; transform: translateX(-50%);">ğŸ’</div>
      <div class="orbit-emoji" style="left: -14px; top: 50%; transform: translateY(-50%);">ğŸ€</div>
      <div class="orbit-emoji" style="right: -14px; top: 50%; transform: translateY(-50%);">ğŸ’˜</div>
    </div>
  </div>
  <header class="topbar">
    <div class="topbar__inner">
      <div class="topbar__left">
        <a class="logo" href="home.html" aria-label="DateMe Home">
          <svg class="logoMark" viewBox="0 0 120 120" role="img" aria-hidden="true">
            <path
              d="M60 104
                 C60 104, 18 76, 18 42
                 C18 22, 34 10, 50 10
                 C67 10, 79 23, 84 33
                 C89 23, 101 10, 118 10
                 C134 10, 150 22, 150 42
                 C150 76, 60 104, 60 104 Z"
              fill="none"
              stroke="rgba(255,255,255,.92)"
              stroke-width="8"
              stroke-linejoin="round"
              stroke-linecap="round"
              transform="translate(-24,0)"
            />
            <path
              d="M60 100
                 C60 100, 24 74, 24 44
                 C24 28, 36 18, 50 18
                 C64 18, 74 27, 80 36
                 C86 27, 96 18, 110 18
                 C124 18, 136 28, 136 44
                 C136 74, 60 100, 60 100 Z"
              fill="none"
              stroke="rgba(255,77,109,.95)"
              stroke-width="4"
              stroke-linejoin="round"
              stroke-linecap="round"
              transform="translate(-8,0)"
              opacity=".95"
            />
          </svg>
          <span class="logoType"><b>Date</b>Me</span>
        </a>
      </div>
      <div class="topbar__right">
        <a class="pill ghost" href="home.html">Back</a>
        <a class="nav__link upgrade" href="profile-upgrade.html">Upgrade</a>
      </div>
    </div>
  </header>

  <main class="layout" style="grid-template-columns:1fr;">
    <section class="content" style="max-width:980px; margin:0 auto;">
      <div class="cardbox profileHero">
        <div class="profileHero__media">
          <img id="pvHeroImg" alt="" />
        </div>
        <div class="profileHero__info">
          <h1 id="pvName">Profile</h1>
          <p class="muted" id="pvMeta">â€”</p>
          <p class="muted" id="pvStatus">â€”</p>
          <div class="profileStats">
            <span id="pvLikes" class="muted">0 likes</span>
          </div>
          <div class="profileActions">
            <a class="btn primary" id="pvChatBtn" href="inbox.html">Chat now</a>
            <button class="btn" id="pvLikeBtn" type="button">â™¡ Like</button>
          </div>
          <div class="chips" id="pvTags"></div>
        </div>
      </div>

      <div class="profileGrid">
        <div class="cardbox">
          <h3 class="sideTitle">Profile Gallery</h3>
          <div class="profileGallery" id="pvGallery"></div>
          <div style="height:10px"></div>
        </div>

        <div class="cardbox">
          <h3 class="sideTitle">Contact & Address</h3>
          <div class="lockedList">
            <div class="lockedRow"><span>Phone</span><b>Locked</b></div>
            <div class="lockedRow"><span>Instagram</span><b>Locked</b></div>
            <div class="lockedRow"><span>Home Address</span><b>Locked</b></div>
          </div>
          <div style="height:10px"></div>
          <a class="btn primary" href="profile-upgrade.html">Upgrade to Unlock</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const gender = params.get("gender") || "women";

    // Get current user info
    const currentUser = (() => {
      try{
        const u = localStorage.getItem("dateme_current_user");
        return u ? JSON.parse(u) : null;
      }catch(e){ return null; }
    })();

    function getProfiles(){
      try{ return JSON.parse(localStorage.getItem("dateme_profiles") || "[]"); }
      catch(e){ return []; }
    }

    const profilesKey = `dateme_profiles_${gender}`;
    const p = (() => {
      try{
        const list = JSON.parse(localStorage.getItem(profilesKey) || "[]");
        return list.find(x => String(x.id) === String(id)) || null;
      }catch(e){
        return getProfiles().find(x => String(x.id) === String(id)) || null;
      }
    })();
    const likeMap = (() => {
      try{ return JSON.parse(localStorage.getItem("dateme_like_counts") || "{}"); }
      catch(e){ return {}; }
    })();
    const lastSeenMap = (() => {
      try{ return JSON.parse(localStorage.getItem("dateme_last_seen_map") || "{}"); }
      catch(e){ return {}; }
    })();

    // Check if current user is viewing their own profile
    const isOwnProfile = currentUser && String(currentUser.id) === String(id);

    function formatLastSeen(ts){
      if (!ts) return "Last seen a few hours ago";
      const diffMs = Date.now() - Number(ts);
      const mins = Math.floor(diffMs / 60000);
      const hours = Math.floor(mins / 60);
      if (mins < 60) return `Last seen ${Math.max(1, mins)} min ago`;
      if (hours < 24) return `Last seen ${hours} hour${hours === 1 ? "" : "s"} ago`;
      const days = Math.floor(hours / 24);
      return `Last seen ${days} day${days === 1 ? "" : "s"} ago`;
    }

    function formatTime(ts){
      const d = new Date(ts);
      const hh = d.getHours();
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ap = hh >= 12 ? "PM" : "AM";
      const h12 = String(((hh + 11) % 12) + 1);
      return `${h12}:${mm} ${ap}`;
    }

    if (p){
      const hero = document.getElementById("pvHeroImg");
      if (hero) hero.src = p.img;
      document.getElementById("pvName").textContent = `${p.name}, ${p.age}`;
      document.getElementById("pvMeta").textContent = `${p.city}, ${p.country}`;
      const status = document.getElementById("pvStatus");
      const lastSeen = lastSeenMap[`${gender}-${p.id}`];
      if (status){
        status.textContent = p.online ? "Online now" : `${formatLastSeen(lastSeen)}${lastSeen ? ` â€¢ ${formatTime(lastSeen)}` : ""}`;
      }
      const likesEl = document.getElementById("pvLikes");
      if (likesEl){
        // Count total unique likes for this profile
        const profileLikePrefix = `${gender}-${p.id}-`;
        const totalLikes = Object.keys(likeMap)
          .filter(k => k.startsWith(profileLikePrefix))
          .length;
        likesEl.textContent = `${totalLikes} likes`;
      }
      const chatBtn = document.getElementById("pvChatBtn");
      if (chatBtn){
        chatBtn.href = `inbox.html?gender=${encodeURIComponent(gender)}&id=${encodeURIComponent(p.id)}`;
      }
      const tags = document.getElementById("pvTags");
      if (tags){
        tags.innerHTML = (p.tags || []).map(t => `<span class="tag">${t}</span>`).join("");
      }
      const gallery = document.getElementById("pvGallery");
      if (gallery){
        const pictures = Array.isArray(p.pictures) && p.pictures.length > 0 ? p.pictures : [];
        const items = pictures.slice(0, 10).map(pic => `
          <div class="profileThumb">
            <img src="${pic}" alt="Gallery photo" />
          </div>
        `);
        gallery.innerHTML = items.length > 0 ? items.join("") : `
          <div style="grid-column: 1 / -1; text-align: center; padding: 24px; color: var(--muted);">
            No photos uploaded yet
          </div>
        `;
      }
    }

    function showLikePop(){
      let pop = document.querySelector(".likePop");
      if (!pop){
        pop = document.createElement("div");
        pop.className = "likePop";
        pop.textContent = "Liked ğŸ’—";
        document.body.appendChild(pop);
      }
      pop.classList.remove("show");
      void pop.offsetWidth;
      pop.classList.add("show");
      setTimeout(() => pop.classList.remove("show"), 1400);
    }

    const likeBtn = document.getElementById("pvLikeBtn");
    if (likeBtn){
      // Disable like button if viewing own profile
      if (isOwnProfile){
        likeBtn.disabled = true;
        likeBtn.title = "You can't like your own profile";
        likeBtn.style.opacity = "0.5";
        likeBtn.style.cursor = "not-allowed";
      }
      
      likeBtn.addEventListener("click", () => {
        if (!p || isOwnProfile) return;
        
        // Use current user ID (0 if not logged in)
        const userId = (currentUser && currentUser.id) || "guest";
        const likeKey = `${gender}-${p.id}-img0-${userId}`;
        
        // Check if already liked
        if (likeMap[likeKey]){
          return; // Already liked this picture
        }
        
        likeBtn.classList.add("liked");
        likeMap[likeKey] = true;
        localStorage.setItem("dateme_like_counts", JSON.stringify(likeMap));
        
        // Update like count
        const profileLikePrefix = `${gender}-${p.id}-`;
        const totalLikes = Object.keys(likeMap)
          .filter(k => k.startsWith(profileLikePrefix))
          .length;
        
        const likesEl = document.getElementById("pvLikes");
        if (likesEl) likesEl.textContent = `${totalLikes} likes`;
        showLikePop();
      });
    }
  </script>
</body>
</html>
